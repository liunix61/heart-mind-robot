# 语音识别质量优化说明

## 问题描述

用户反馈：打包后的语音输入识别不准确，"听不懂我说的话"

## 优化措施（v1.0.2）

### 1. Opus编码器配置优化

**问题分析：**
- 原配置使用 `OPUS_APPLICATION_VOIP`（适用于VoIP通话）
- 比特率较低（16kHz时仅24kbps）
- 针对实时通话优化，但不是语音识别的最佳选择

**改进方案：**

#### 应用模式改变
```cpp
// 之前：VOIP模式
OPUS_APPLICATION_VOIP

// 现在：AUDIO模式（更高音质）
OPUS_APPLICATION_AUDIO
```

#### 比特率提升
```cpp
// 之前：
8kHz  -> 12kbps
16kHz -> 24kbps
24kHz -> 32kbps

// 现在：
8kHz  -> 20kbps  (+67%)
16kHz -> 32kbps  (+33%)
24kHz -> 48kbps  (+50%)
```

#### 新增配置
```cpp
// 1. 设置信号类型为语音
OPUS_SET_SIGNAL(OPUS_SIGNAL_VOICE)

// 2. 设置VBR约束模式
OPUS_SET_VBR_CONSTRAINT(1)

// 3. 设置包丢失期望为0（理想网络）
OPUS_SET_PACKET_LOSS_PERC(0)

// 4. 保持最高复杂度
OPUS_SET_COMPLEXITY(10)

// 5. 设置更宽的带宽
16kHz -> OPUS_BANDWIDTH_WIDEBAND (8kHz带宽)
24kHz -> OPUS_BANDWIDTH_SUPERWIDEBAND (12kHz带宽)
```

### 2. 技术对比

#### OPUS_APPLICATION_VOIP vs OPUS_APPLICATION_AUDIO

| 特性 | VOIP模式 | AUDIO模式 |
|------|----------|----------|
| 目标 | 低延迟实时通话 | 高保真音频 |
| 比特率 | 较低 | 较高 |
| 音质 | 适中 | 优秀 |
| 带宽使用 | 节省 | 较多 |
| 语音识别准确度 | 一般 | 更好 |
| 延迟 | 极低 | 低 |

### 3. 预期效果

**音质改善：**
- ✅ 更清晰的语音信号
- ✅ 保留更多语音细节（高频信息）
- ✅ 更少的压缩失真
- ✅ 更好的音频动态范围

**识别准确度提升：**
- ✅ 服务器端ASR引擎能接收到更高质量的音频
- ✅ 减少因编码失真导致的识别错误
- ✅ 特别是对声母、韵母的识别更准确
- ✅ 环境噪音影响减少（结合WebRTC处理）

**带宽成本：**
- 16kHz采样率：从24kbps → 32kbps（+33%）
- 对于语音输入场景（按住说话），带宽增加可以接受

### 4. 代码改动

#### AudioInputManager.cpp
```cpp
// 修改编码器应用类型
OPUS_APPLICATION_VOIP → OPUS_APPLICATION_AUDIO

// 提高比特率
根据采样率设置更高的目标比特率

// 新增带宽设置
setBandwidth(OPUS_BANDWIDTH_WIDEBAND/SUPERWIDEBAND)
```

#### OpusEncoder.cpp
```cpp
// 新增初始化参数
- OPUS_SET_VBR_CONSTRAINT(1)
- OPUS_SET_SIGNAL(OPUS_SIGNAL_VOICE)
- OPUS_SET_PACKET_LOSS_PERC(0)

// 新增方法
bool setBandwidth(int bandwidth)
```

### 5. 测试建议

#### 对比测试
1. **准备测试语句：**
   - 包含声母韵母组合：zh、ch、sh、r等
   - 包含相似音：f/h、n/l、an/ang等
   - 包含多音字和专业词汇

2. **测试环境：**
   - 安静环境：测试基础识别准确度
   - 有背景噪音：测试抗干扰能力
   - 不同说话速度：快速、正常、慢速

3. **对比指标：**
   - 整体识别准确率
   - 声母识别准确率
   - 词汇识别准确率
   - 标点符号准确性

#### 测试方法
```
1. 旧版本（VOIP 24kbps）测试10次，记录准确率
2. 新版本（AUDIO 32kbps）测试10次，记录准确率
3. 对比改善幅度
```

### 6. 监控和日志

新版本会在启动时输出详细配置：

```
Opus encoder configured for speech recognition:
  Application: AUDIO (better quality for ASR)
  Bitrate: 32000 bps
  Sample rate: 16000 Hz
Bandwidth set to: Wideband (8kHz)
```

### 7. 进一步优化建议

如果识别准确度仍然不够理想：

#### 客户端优化
1. **提高采样率**
   - 从16kHz → 24kHz或48kHz
   - 需要更多带宽，但识别质量更好

2. **优化WebRTC降噪**
   - 调整降噪强度
   - 针对不同环境自适应

3. **音频预处理**
   - 自动增益控制（AGC）
   - 回声消除（AEC）
   - 音量归一化

#### 服务器端优化
1. **选择更好的ASR模型**
   - 支持更高采样率的模型
   - 针对方言或口音优化的模型

2. **热词配置**
   - 添加专业词汇
   - 添加用户常用词

3. **后处理**
   - 语言模型纠错
   - 上下文理解

### 8. 回退方案

如果新配置导致问题，可以快速回退：

```cpp
// AudioInputManager.cpp line 88
// 改回：
OPUS_APPLICATION_VOIP

// line 94-101
// 改回原来的比特率
int bitrate = 24000;
if (m_sampleRate == 8000) {
    bitrate = 12000;
} else if (m_sampleRate >= 24000) {
    bitrate = 32000;
}
```

### 9. 性能影响

**CPU使用：**
- COMPLEXITY(10)：CPU使用略高
- 对于现代设备影响极小（<1% CPU）

**内存使用：**
- 编码缓冲区：4KB
- 无明显增加

**带宽使用：**
- 增加约33%（24→32kbps）
- 对于语音输入场景可接受

**电池消耗：**
- 基本无影响（仅在录音时工作）

### 10. 版本历史

**v1.0.0**
- OPUS_APPLICATION_VOIP
- 16kHz @ 24kbps
- 基础语音识别功能

**v1.0.1**
- 修复资源加载和麦克风权限问题
- 无编码器改动

**v1.0.2** ← 当前版本
- OPUS_APPLICATION_AUDIO
- 16kHz @ 32kbps
- 带宽优化（Wideband）
- 针对语音识别优化

---

## 总结

通过将Opus编码器从VOIP模式切换到AUDIO模式，并提高比特率和带宽，预期可以显著改善语音识别准确度，特别是在识别复杂音节和相似音时。

这些改动在保持低延迟的同时，提供了更高质量的音频流给服务器端ASR系统，是一个平衡性能和效果的优化方案。

**建议：** 在实际部署前进行AB测试，对比新旧配置的识别准确率差异。

